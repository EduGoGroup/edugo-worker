name: Sync Main to Dev

# Se ejecuta despu√©s de push a main (generalmente despu√©s de auto-version)
on:
  push:
    branches: [main]
    tags:
      - 'v*'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: Create PR to sync main ‚Üí dev
    runs-on: ubuntu-latest
    # Solo ejecutar si NO es un commit de bot (evitar loops)
    if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, 'chore: sync')"

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Obtener versi√≥n actual
        id: version
        run: |
          if [ -f ".github/version.txt" ]; then
            VERSION=$(cat .github/version.txt)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "üìå Versi√≥n actual: v$VERSION"
          else
            echo "version=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Verificar si dev existe
        id: check_dev
        run: |
          if git ls-remote --heads origin dev | grep -q dev; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úì Rama dev existe"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Rama dev no existe, se crear√°"
          fi

      - name: Crear rama dev si no existe
        if: steps.check_dev.outputs.exists == 'false'
        run: |
          git checkout -b dev
          git push -u origin dev
          echo "‚úì Rama dev creada"

      - name: Verificar si hay diferencias
        id: check_diff
        run: |
          git fetch origin dev
          if git diff --quiet origin/main origin/dev; then
            echo "has_diff=false" >> $GITHUB_OUTPUT
            echo "‚úì main y dev est√°n sincronizados"
          else
            echo "has_diff=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Hay diferencias entre main y dev"
          fi

      - name: Merge main to dev directamente
        if: steps.check_diff.outputs.has_diff == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Configurar git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Checkout dev y merge main
          git checkout dev
          git merge origin/main --no-ff -m "chore: sync main v$VERSION to dev

          Sincronizaci√≥n autom√°tica de main a dev despu√©s de cambios en main.

          ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>"

          # Push a dev
          git push origin dev

          echo "‚úÖ main sincronizado a dev correctamente"

      - name: Resumen
        run: |
          echo "# üîÑ Sincronizaci√≥n Main ‚Üí Dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Aspecto | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Versi√≥n | v${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rama dev existe | ${{ steps.check_dev.outputs.exists }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Diferencias | ${{ steps.check_diff.outputs.has_diff }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_diff.outputs.has_diff }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ Merge autom√°tico completado" >> $GITHUB_STEP_SUMMARY
            echo "üìç dev se sincroniz√≥ con main correctamente" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ main y dev ya est√°n sincronizados" >> $GITHUB_STEP_SUMMARY
          fi
