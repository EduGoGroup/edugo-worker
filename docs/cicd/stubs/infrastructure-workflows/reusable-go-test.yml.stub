# STUB: reusable-go-test.yml
# Este es un STUB para FASE 1 del SPRINT-4
# UbicaciÃ³n real (FASE 2): edugo-infrastructure/.github/workflows/reusable-go-test.yml

name: Reusable - Go Tests with Coverage

on:
  workflow_call:
    inputs:
      go-version:
        description: 'Go version to use'
        required: false
        type: string
        default: '1.25'

      coverage-threshold:
        description: 'Minimum coverage threshold (%)'
        required: false
        type: number
        default: 33.0

      use-services:
        description: 'Use services (PostgreSQL, MongoDB, RabbitMQ)'
        required: false
        type: boolean
        default: true

jobs:
  test-coverage:
    name: Run Tests with Coverage
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: edugo_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      mongodb:
        image: mongo:7
        env:
          MONGO_INITDB_ROOT_USERNAME: mongo
          MONGO_INITDB_ROOT_PASSWORD: mongo
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017

      rabbitmq:
        image: rabbitmq:3-management-alpine
        env:
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5672:5672
          - 15672:15672

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}
          cache: true

      - name: Setup EduGo Go (access private repos)
        uses: EduGoGroup/edugo-infrastructure/.github/actions/setup-edugo-go@main
        with:
          github-token: ${{ github.token }}  # âœ… Usa github.token (no declarar como secret)

      - name: Wait for services
        if: ${{ inputs.use-services }}
        run: sleep 10

      - name: Run tests with coverage
        env:
          POSTGRES_URL: postgresql://postgres:postgres@localhost:5432/edugo_test?sslmode=disable
          MONGODB_URL: mongodb://mongo:mongo@localhost:27017/edugo_test?authSource=admin
          RABBITMQ_URL: amqp://guest:guest@localhost:5672/
        run: |
          mkdir -p coverage
          go test -v -race -coverprofile=coverage/coverage.out -covermode=atomic ./...

      - name: Verify coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage/coverage.out | tail -1 | awk '{print $NF}' | sed 's/%//')
          THRESHOLD=${{ inputs.coverage-threshold }}

          echo "ðŸ“Š Current Coverage: ${COVERAGE}%"
          echo "ðŸ“Š Minimum Threshold: ${THRESHOLD}%"

          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "âŒ Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            exit 1
          else
            echo "âœ… Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"
          fi

      - name: Generate HTML report
        run: |
          if [ -f coverage/coverage.out ]; then
            go tool cover -html=coverage/coverage.out -o coverage/coverage.html
          fi

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Upload to Codecov
        uses: codecov/codecov-action@v3
        if: success()
        with:
          file: coverage/coverage.out
          flags: ${{ github.event.repository.name }}
          fail_ci_if_error: false

      - name: Generate summary
        if: always()
        run: |
          echo "# ðŸ“Š Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f coverage/coverage.out ]; then
            coverage=$(go tool cover -func=coverage/coverage.out | tail -1 | awk '{print $NF}')
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Coverage | $coverage |" >> $GITHUB_STEP_SUMMARY
            echo "| Threshold | ${{ inputs.coverage-threshold }}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Services | ${{ inputs.use-services }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No coverage report generated" >> $GITHUB_STEP_SUMMARY
          fi

# =====================================================
# LECCIONES APRENDIDAS APLICADAS:
# =====================================================
#
# âœ… NO usar subdirectorio
#    - Archivo en: .github/workflows/reusable-go-test.yml (raÃ­z)
#    - NO en: .github/workflows/reusable/go-test.yml
#
# âœ… NO declarar secret GITHUB_TOKEN
#    - GITHUB_TOKEN es nombre reservado
#    - Usar github.token directamente en steps
#
# âœ… Compatible con Go 1.25
#    - setup-go@v5 soporta Go 1.25
#
# Referencia: docs/cicd/SPRINT-4-LESSONS-LEARNED.md
# =====================================================
